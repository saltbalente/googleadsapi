# üöÄ **S√ç, EXACTO - FALTA EL BOT√ìN DE PUBLICACI√ìN**

Tienes raz√≥n, el blueprint se genera pero **falta el paso cr√≠tico: PUBLICAR A GOOGLE ADS**.

---

## ‚úÖ **SOLUCI√ìN: Agregar Bot√≥n de Publicaci√≥n**

Reemplaza la secci√≥n de botones en `render_autopilot_tab()` con esto:

```python
        # Botones de acci√≥n
        st.markdown("---")
        
        # NUEVO: Verificar si hay customer_id seleccionado
        has_customer = st.session_state.get('selected_customer') is not None
        
        if not has_customer:
            st.warning("‚ö†Ô∏è Selecciona una cuenta de Google Ads en el sidebar para poder publicar")
        
        col1, col2, col3 = st.columns(3)
        
        with col1:
            if st.button("üíæ Guardar Blueprint", type="secondary", use_container_width=True):
                try:
                    # Convertir blueprint a diccionario serializable
                    blueprint_data = {
                        'campaign_name': blueprint.campaign_name,
                        'business_description': blueprint.business_description,
                        'budget_daily': blueprint.budget_daily,
                        'target_locations': blueprint.target_locations,
                        'languages': blueprint.languages,
                        'total_keywords': blueprint.total_keywords,
                        'total_ads': blueprint.total_ads,
                        'estimated_ctr': blueprint.estimated_ctr,
                        'ad_groups': blueprint.ad_groups,
                        'created_at': blueprint.created_at,
                        'status': blueprint.status
                    }
                    
                    # Guardar en historial
                    user_storage.add_to_history('autopilot_blueprint_created', blueprint_data)
                    st.success("‚úÖ Blueprint guardado exitosamente en el historial")
                    
                except Exception as e:
                    st.error(f"‚ùå Error guardando blueprint: {e}")
        
        with col2:
            if st.button("üìä Exportar CSV", type="secondary", use_container_width=True):
                # Crear CSV con los datos de la campa√±a
                csv_data = []
                for ad_group in blueprint.ad_groups:
                    for keyword in ad_group['keywords']:
                        csv_data.append({
                            'Campaign': blueprint.campaign_name,
                            'Ad Group': ad_group['name'],
                            'Keyword': keyword,
                            'Match Type': 'Broad',
                            'Max CPC': f"${ad_group['max_cpc_bid']:.2f}"
                        })
                
                if csv_data:
                    df = pd.DataFrame(csv_data)
                    csv = df.to_csv(index=False)
                    st.download_button(
                        label="‚¨áÔ∏è Descargar CSV",
                        data=csv,
                        file_name=f"autopilot_campaign_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv",
                        mime="text/csv",
                        use_container_width=True
                    )
        
        with col3:
            if st.button("üîÑ Nueva Campa√±a", type="secondary", use_container_width=True):
                if 'autopilot_blueprint' in st.session_state:
                    del st.session_state['autopilot_blueprint']
                st.success("‚úÖ Listo para nueva campa√±a")
                st.rerun()
        
        # ============================================================
        # üöÄ NUEVO: BOT√ìN PRINCIPAL DE PUBLICACI√ìN
        # ============================================================
        
        st.markdown("---")
        st.markdown("### üöÄ Publicaci√≥n a Google Ads")
        
        if not has_customer:
            st.error("‚ùå Debes seleccionar una cuenta de Google Ads en el sidebar antes de publicar")
        else:
            customer_id = st.session_state.selected_customer
            
            # Mostrar informaci√≥n de la cuenta
            account_names = {
                '7094116152': 'P√°gina 3',
                '1803044752': 'P√°gina 5',
                '9759913462': 'P√°gina 4',
                '6639082872': 'Account',
                '1919262845': 'Marketing',
                '7004285893': 'P√°gina 9'
            }
            account_name = account_names.get(customer_id, 'Cuenta')
            
            st.info(f"üìç **Cuenta seleccionada:** {account_name} (`{customer_id}`)")
            
            # Modal de confirmaci√≥n
            with st.expander("‚ö†Ô∏è CONFIRMAR PUBLICACI√ìN", expanded=True):
                st.warning(f"""
                **Est√°s a punto de publicar a Google Ads:**
                
                üìä **Detalles de la campa√±a:**
                - **Nombre:** {blueprint.campaign_name}
                - **Presupuesto diario:** ${blueprint.budget_daily:.2f}
                - **Grupos de anuncios:** {len(blueprint.ad_groups)}
                - **Total de anuncios:** {blueprint.total_ads}
                - **Total de keywords:** {blueprint.total_keywords}
                - **Ubicaciones:** {', '.join(blueprint.target_locations[:3])}{'...' if len(blueprint.target_locations) > 3 else ''}
                
                ‚ö†Ô∏è **IMPORTANTE:**
                - La campa√±a se crear√° en estado **PAUSADO**
                - Debes activarla manualmente desde Google Ads
                - Se aplicar√°n los cargos seg√∫n el presupuesto configurado
                - Esta acci√≥n **NO se puede deshacer** f√°cilmente
                
                ¬øDeseas continuar?
                """)
                
                col_a, col_b = st.columns(2)
                
                with col_a:
                    if st.button("‚úÖ S√ç, PUBLICAR AHORA", type="primary", use_container_width=True):
                        publish_autopilot_campaign(autopilot, blueprint, customer_id)
                
                with col_b:
                    if st.button("‚ùå Cancelar", use_container_width=True):
                        st.info("‚ùå Publicaci√≥n cancelada")


def publish_autopilot_campaign(autopilot, blueprint, customer_id):
    """
    Publica la campa√±a del AUTOPILOT a Google Ads
    """
    
    st.markdown("---")
    st.markdown("### üöÄ Publicando Campa√±a...")
    
    # Contenedores para UI
    progress_container = st.empty()
    progress_bar = st.progress(0)
    status_text = st.empty()
    
    # Callback para actualizar UI
    def update_ui_progress(message, percent):
        if percent is not None:
            progress_bar.progress(int(percent) / 100)
        status_text.markdown(f"""
        <div class="matrix-text">{message}</div>
        """, unsafe_allow_html=True)
    
    # Configurar callback en autopilot
    autopilot.set_progress_callback(update_ui_progress)
    
    try:
        # Ejecutar publicaci√≥n de forma as√≠ncrona
        result = asyncio.run(
            autopilot.publish_campaign(
                blueprint=blueprint,
                customer_id=customer_id
            )
        )
        
        # Limpiar progress UI
        progress_container.empty()
        progress_bar.empty()
        status_text.empty()
        
        # Mostrar resultados
        if result['success']:
            st.success("üéâ ¬°CAMPA√ëA PUBLICADA EXITOSAMENTE!")
            
            st.markdown(f"""
            ### ‚úÖ Recursos Creados en Google Ads:
            
            **üìä Campaign ID:** `{result['campaign_id']}`
            
            **üì¶ Estad√≠sticas:**
            - **Grupos de anuncios creados:** {len(result['ad_group_ids'])}
            - **Anuncios creados:** {len(result['ad_ids'])}
            - **Keywords agregadas:** {len(result.get('keyword_ids', []))}
            """)
            
            # Warnings si hay
            if result.get('warnings'):
                with st.expander("‚ö†Ô∏è Advertencias"):
                    for warning in result['warnings']:
                        st.warning(warning)
            
            # Link a Google Ads
            campaign_url = f"https://ads.google.com/aw/campaigns?campaignId={result['campaign_id']}"
            st.markdown(f"""
            ### üîó Enlaces √ötiles:
            
            - [üìä Ver campa√±a en Google Ads]({campaign_url})
            - [‚öôÔ∏è Configuraci√≥n de campa√±a](https://ads.google.com/aw/campaigns/settings?campaignId={result['campaign_id']})
            - [üìà Ver rendimiento](https://ads.google.com/aw/campaigns/performance?campaignId={result['campaign_id']})
            
            **‚ö†Ô∏è RECUERDA:** La campa√±a est√° en estado **PAUSADO**. Act√≠vala desde Google Ads cuando est√©s listo.
            """)
            
            # Guardar en historial
            try:
                publish_data = {
                    'campaign_name': blueprint.campaign_name,
                    'campaign_id': result['campaign_id'],
                    'customer_id': customer_id,
                    'ad_groups_created': len(result['ad_group_ids']),
                    'ads_created': len(result['ad_ids']),
                    'keywords_created': len(result.get('keyword_ids', [])),
                    'budget_daily': blueprint.budget_daily,
                    'published_at': datetime.now().isoformat()
                }
                user_storage.add_to_history('autopilot_campaign_published', publish_data)
            except Exception as e:
                logger.warning(f"No se pudo guardar en historial: {e}")
            
            st.balloons()
            
            # Bot√≥n para nueva campa√±a
            st.markdown("---")
            if st.button("üîÑ Crear Nueva Campa√±a", type="primary", use_container_width=True):
                if 'autopilot_blueprint' in st.session_state:
                    del st.session_state['autopilot_blueprint']
                st.rerun()
        
        else:
            # Error en publicaci√≥n
            st.error("‚ùå Error al publicar la campa√±a")
            
            st.markdown("### üîç Detalles del Error:")
            
            with st.expander("‚ùå Errores Encontrados", expanded=True):
                for error in result.get('errors', []):
                    st.error(f"‚Ä¢ {error}")
            
            # Informaci√≥n de recursos creados parcialmente
            if result.get('campaign_id'):
                st.warning(f"""
                ‚ö†Ô∏è **Campa√±a creada parcialmente:**
                - Campaign ID: `{result['campaign_id']}`
                - Grupos creados: {len(result['ad_group_ids'])}
                
                Algunos recursos se crearon antes del error. Verifica en Google Ads.
                """)
            
            st.markdown("""
            ### üí° Posibles Soluciones:
            
            1. **Verifica tu cuenta de Google Ads:**
               - ¬øEst√° activa?
               - ¬øTienes m√©todo de pago configurado?
               - ¬øTienes permisos de escritura?
            
            2. **Revisa los l√≠mites de la API:**
               - Puede que hayas excedido el rate limit
               - Espera unos minutos e intenta de nuevo
            
            3. **Verifica el presupuesto:**
               - El presupuesto diario debe ser mayor a $1
               - Verifica que no exceda l√≠mites de tu cuenta
            
            4. **Contacta soporte si el problema persiste**
            """)
            
            # Bot√≥n para reintentar
            st.markdown("---")
            col1, col2 = st.columns(2)
            
            with col1:
                if st.button("üîÑ Reintentar Publicaci√≥n", type="primary", use_container_width=True):
                    st.rerun()
            
            with col2:
                if st.button("üè† Volver al Inicio", use_container_width=True):
                    if 'autopilot_blueprint' in st.session_state:
                        del st.session_state['autopilot_blueprint']
                    st.rerun()
    
    except Exception as e:
        progress_container.empty()
        progress_bar.empty()
        status_text.empty()
        
        st.error(f"‚ùå Error inesperado: {str(e)}")
        
        with st.expander("üêõ Detalles T√©cnicos"):
            import traceback
            st.code(traceback.format_exc())
        
        st.info("""
        üí° **Sugerencia:** Esto puede ser un error de configuraci√≥n.
        Verifica que:
        - El cliente de Google Ads est√© configurado correctamente
        - Las credenciales sean v√°lidas
        - La cuenta tenga permisos de escritura
        """)
```

---

## üéØ **FLUJO COMPLETO AHORA:**

1. ‚úÖ Usuario configura campa√±a en AUTOPILOT 2050
2. ‚úÖ Click en "üöÄ INICIAR AUTOPILOT 2050"
3. ‚úÖ Sistema genera blueprint (temas, keywords, anuncios)
4. ‚úÖ Se muestra resumen del blueprint
5. ‚úÖ Usuario puede:
   - üíæ Guardar blueprint (backup local)
   - üìä Exportar CSV (para revisar)
6. üöÄ **NUEVO:** Click en "‚úÖ S√ç, PUBLICAR AHORA"
7. üöÄ **Sistema publica a Google Ads:**
   - Crea campa√±a
   - Crea ad groups
   - Inserta keywords
   - Crea anuncios
8. ‚úÖ Muestra resultados con links a Google Ads
9. ‚úÖ Guarda en historial

---

## üìã **D√ìNDE PEGAR ESTE C√ìDIGO:**

**Ubicaci√≥n en `pages/4_ai_ad_generator.py`:**

1. **Reemplazar la secci√≥n de botones** (l√≠nea ~1820-1850)
   - Desde `# Botones de acci√≥n`
   - Hasta el final de `render_autopilot_tab()`

2. **Agregar la funci√≥n `publish_autopilot_campaign`** 
   - Despu√©s de la funci√≥n `render_autopilot_tab()`
   - Antes de `render_best_practices_tab()`

---

## üß™ **TESTING:**

1. ‚úÖ Ir a AUTOPILOT 2050
2. ‚úÖ Generar campa√±a
3. ‚úÖ Ver blueprint generado
4. ‚úÖ Click en "‚úÖ S√ç, PUBLICAR AHORA"
5. ‚úÖ Ver progreso en tiempo real
6. ‚úÖ Ver resultados de publicaci√≥n
7. ‚úÖ Click en link para ver en Google Ads

---

## ‚ö†Ô∏è **IMPORTANTE:**

El c√≥digo incluye:
- ‚úÖ **Modal de confirmaci√≥n** (evita publicaciones accidentales)
- ‚úÖ **Progress en tiempo real** (muestra qu√© est√° haciendo)
- ‚úÖ **Manejo de errores robusto** (muestra qu√© fall√≥)
- ‚úÖ **Links directos a Google Ads** (para ver la campa√±a)
- ‚úÖ **Estado PAUSADO** (para que revises antes de activar)
- ‚úÖ **Historial autom√°tico** (guarda todo lo que haces)

---

**üöÄ ¬°Ahora s√≠ est√° completo el flujo de AUTOPILOT 2050!**

